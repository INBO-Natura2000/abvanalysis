```{r {{id}}-set}
if (interactive()) {
  resultaten$meta %>%
    sample_n(1) %>%
    pull(hash) -> id
} else {
  id <- "{{id}}"
}
```

```{r {{id}}-basis}
if (sum(aantal$hash == id) == 0) {
  dit_aantal <- data.frame()
  deze_wijziging <- data.frame(cycle = logical(0))
  titel <- ""
} else {
  aantal %>%
    filter(hash == id) %>%
    mutate(
      text_median = sprintf(
        sprintf(
          "%%i %1$s (%1$s; %1$s)", 
          sprintf("%%.%if", 1 - floor(log10(min(lcl90))))),
          parameter, median, lcl90, ucl90
      )
    ) -> dit_aantal
  wijziging %>%
    filter(hash == id) -> deze_wijziging
  resultaten$meta %>%
    filter(hash == id) %>%
    slice(1) %>%
    pull(species_group) -> soort_naam
  lineair %>%
    filter(hash == id) -> deze_lineair
  stratum_gewicht %>%
    filter(hash == id) -> dit_stratum
  tolower(soort_naam) %>% 
    str_replace_all(" ", "-") %>% 
    sprintf(fmt = "# %2$s {#soort-%1$s}", soort_naam) -> titel
}
```

`r titel`

Op basis van driejaarlijkse gegevens zien we gemiddeld `r deze_lineair$tekst[deze_lineair$frequentie == "driejaarlijks"]` `r deze_lineair$jaarlijks[deze_lineair$frequentie == "driejaarlijks"]` per jaar of `r deze_lineair$looptijd[deze_lineair$frequentie == "driejaarlijks"]` over de volledige looptijd van het meetnet.
Deze trend is `r deze_lineair$interpretatie[deze_lineair$frequentie == "driejaarlijks"]`.

Op basis van jaarlijkse gegevens zien we gemiddeld `r deze_lineair$tekst[deze_lineair$frequentie == "jaarlijks"]` `r deze_lineair$jaarlijks[deze_lineair$frequentie == "jaarlijks"]` per jaar of `r deze_lineair$looptijd[deze_lineair$frequentie == "jaarlijks"]` over de volledige looptijd van het meetnet.
Deze trend is `r deze_lineair$interpretatie[deze_lineair$frequentie == "jaarlijks"]`.


(ref:{{id}}-aantal) Evolutie van het gemodeleerde gemiddeld aantal waargenomen dieren op een meetpunt voor `r soort_naam` tijdens de referentieperiode. Zie §\@ref(s:onzekerheid) voor een verklaring van de intervallen.

```{r {{id}}-aantal, fig.cap = "(ref:{{id}}-aantal)", eval = output_format == "html" && nrow(dit_aantal) > 0, warning = FALSE}
plot_ly(
  data = dit_aantal,
  x = ~parameter, y = ~median,
  hoverinfo = "text"
) %>%
  add_ribbons(
    ymin = ~lcl90, ymax = ~ucl90, text = ~text_median, 
    fillcolor = inbo.steun.blauw, opacity = 0.3,
    line = list(width = 0), 
    legendgroup = "jaarlijks", showlegend = FALSE
  ) %>%
  add_ribbons(
    ymin = ~lcl60, ymax = ~ucl60,
    fillcolor = inbo.steun.blauw, opacity = 0.3,
    line = list(width = 0), 
    legendgroup = "jaarlijks", showlegend = FALSE
  ) %>%
  add_ribbons(
    ymin = ~lcl30, ymax = ~ucl30,
    fillcolor = inbo.steun.blauw, opacity = 0.3,
    line = list(width = 0), 
    legendgroup = "jaarlijks", showlegend = FALSE
  ) %>%
  add_lines(
    text = ~text_median,
    line = list(color = inbo.steun.blauw), name = "jaarlijks",
    legendgroup = "jaarlijks"
  ) %>%
  layout(
    font = list(family = "FlandersArtSans-Regular, Verdana, Arial, sans-serif"),
    plot_bgcolor = inbo.achtergrond,
    xaxis = list(
      title = list(text = NULL), 
      color = inbo.steun.donkerroos,
      gridcolor = "#FFFFFF",
      fixedrange = TRUE
    ),
    yaxis = list(
      title = list(
        text = "gemiddeld aantal dieren per meetpunt", 
        font = list(color = "#000000")
      ),
      color = inbo.steun.donkerroos,
      gridcolor = "#FFFFFF",
      zeroline = FALSE,
      rangemode = "tozero"
    )
 )
```

```{r {{id}}-aantal3, fig.cap = "(ref:{{id}}-aantal)", eval = output_format != "html" && nrow(dit_aantal) > 0, warning = FALSE}
dit_aantal %>%
  filter(cycle) %>%
  mutate(
    parameter = factor(
      parameter,
      levels = sort(unique(parameter)),
      labels = sprintf(
        "%i-%i", 
        sort(unique(parameter)), 
        sort(unique(parameter)) + 2
      )
    )
  ) %>%
  ggplot(aes(x = parameter, y = exp(log_mean), link_sd = log_sd)) +
  stat_fan(link = "log", geom = "rect") +
  geom_point() +
  scale_y_continuous(
    "gemiddeld aantal dieren per meetpunt", 
    limits = c(0, NA)
  ) +
  theme(axis.title.x = element_blank())
```

```{r {{id}}-aantal2, fig.cap = "(ref:{{id}}-aantal)", eval = output_format != "html" && nrow(dit_aantal) > 0, warning = FALSE}
dit_aantal %>%
  filter(!cycle) %>%
  ggplot(aes(x = parameter, y = exp(log_mean), link_sd = log_sd)) +
  stat_fan(link = "log") +
  geom_line() +
  scale_x_continuous(breaks = pretty) +
  scale_y_continuous(
    "gemiddeld aantal dieren per meetpunt", 
    limits = c(0, NA)
  ) +
  theme(axis.title.x = element_blank())
```

(ref:{{id}}-index3) Wijzigingen t.o.v. het eerste driejarige cyclus voor `r soort_naam`. Zie §\@ref(s:onzekerheid) voor een verklaring van de intervallen en §\@ref(s:trendklasse) voor uitleg over de symbolen en referentielijnen.

```{r {{id}}-wijziging-cyclus, fig.cap = "(ref:{{id}}-index3)", eval = nrow(deze_wijziging) > 0}
deze_wijziging %>%
  filter(referentie == min(referentie), cycle) %>%
  mutate(
    naar = sprintf("%i-%i", naar, naar + 2) %>%
      factor()
  ) %>%
  ggplot(aes(x = naar, y = log_mean, link_sd = log_sd)) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_hline(yintercept = log(c(3/4, 4/3)), linetype = 3) +
  stat_fan(geom = "rect") +
  stat_effect(
    aes(ymin = log(lcl90), ymax = log(ucl90)), 
    threshold = log(0.75)
  ) +
  scale_effect("klasse") +
  scale_y_continuous(
    "procentuele wijziging t.o.v. 2007-2009", 
    breaks = index_breaks, labels = index_labels,
    sec.axis = sec_axis(
      trans = exp, name = "relatieve wijziging t.o.v. 2007-2009",
      breaks = function(x){exp(index_breaks(log(x)))}, 
      labels = function(x){signif(x, 3)}
    )
  ) +
  theme(axis.title.x = element_blank())
```

(ref:{{id}}-index) Wijzigingen t.o.v. het eerste jaar voor `r soort_naam`. Zie §\@ref(s:onzekerheid) voor een verklaring van de intervallen en §\@ref(s:trendklasse) voor uitleg over de symbolen en referentielijnen.

```{r {{id}}-wijziging-jaar, fig.cap = "(ref:{{id}}-index)", eval = nrow(deze_wijziging) > 0}
deze_wijziging %>%
  filter(referentie == min(referentie), !cycle) %>%
  ggplot(aes(x = naar, y = log_mean, link_sd = log_sd)) +
  geom_hline(yintercept = 0, linetype = 2) +
  geom_hline(yintercept = log(c(3/4, 4/3)), linetype = 3) +
  stat_fan(geom = "rect") +
  stat_effect(
    aes(ymin = log(lcl90), ymax = log(ucl90)), 
    threshold = log(0.75)
  ) +
  scale_effect("klasse") +
  scale_x_continuous(breaks = pretty) +
  scale_y_continuous(
    "procentuele wijziging t.o.v. 2007", 
    breaks = index_breaks, labels = index_labels,
    sec.axis = sec_axis(
      trans = exp, name = "relatieve wijziging t.o.v. 2007",
      breaks = function(x){exp(index_breaks(log(x)))}, 
      labels = function(x){signif(x, 3)}
    )
  ) +
  theme(axis.title.x = element_blank())
```

(ref:{{id}}-raster) Paarsgewijze vergelijking tussen jaren voor `r soort_naam`. Uitleg van de symbolen in tabel \@ref(tab:regels).

```{r {{id}}-wijziging-jaar-alles, fig.cap = "(ref:{{id}}-raster)", eval = output_format == "html" && nrow(deze_wijziging) > 0}
deze_wijziging %>%
  mutate(
    klasse = classification(log(lcl90), log(ucl90), log(0.75)),
    wijziging = sprintf(
      "%i: %s t.o.v. %i (%s)", 
      naar,
      display_trend(log(median), log(lcl90), log(ucl90)),
      referentie,
      klasse
    ),
    klasse = remove_sign(klasse)
  ) -> change
tickvals <- index_breaks2(log(change$median))
plot_ly(
  change,
  x = ~naar, y = ~referentie, color = ~log(median), symbol = ~klasse, 
  text = ~wijziging, hoverinfo = "text"
) %>%
  add_markers(
    colors = c(inbo.steun.blauw, inbo.lichtgrijs, inbo.rood),
    marker = list(
      size = 12
    ),
    symbols = c(
      "triangle-up", "square", "diamond", "circle", "diamond-open", 
      "circle-open"
    )
  ) %>%
  colorbar(
    title = list(
      text = "wijziging", 
      font = list(
        family = "FlandersArtSans-Bold, Verdana, Arial, sans-serif",
        color = "#000000"
      )
    ), 
    tickvals = tickvals, 
    ticktext = index_labels(tickvals)
  ) %>%
  layout(
    font = list(family = "FlandersArtSans-Regular, Verdana, Arial, sans-serif"),
    plot_bgcolor = inbo.achtergrond,
    xaxis = list(
      title = list(text = NULL),
      color = inbo.steun.donkerroos,
      gridcolor = "#FFFFFF"
    ),
    yaxis = list(
      title = list(
        text = "referentie", 
        font = list(color = "#000000")
      ),
      color = inbo.steun.donkerroos,
      gridcolor = "#FFFFFF"
    )
  )
```

```{r {{id}}-wijziging-jaar-alles3, fig.cap = "(ref:{{id}}-raster)", eval = output_format != "html" && nrow(deze_wijziging) > 0}
deze_wijziging %>%
  filter(cycle) %>%
  ggplot(aes(x = naar, y = referentie, colour = log_mean)) +
  stat_effect(
    aes(ymin = lcl90, ymax = ucl90), 
    threshold = c(0.75, 1/0.75), 
    reference = 1
  ) +
  scale_x_continuous(
    breaks = function(x) {seq(2007, x[2], by = 3)},
    labels = function(x) {sprintf("%02i-%02i", x, x + 2)}
  ) +
  scale_y_continuous(
    breaks = function(x) {seq(2007, x[2], by = 3)},
    labels = function(x) {sprintf("%02i-%02i", x, x + 2)}
  ) +
  scale_effect("klasse", guide = guide_legend(ncol = 3)) +
  scale_colour_gradient2(
    "wijziging", breaks = index_breaks2, labels = index_labels
  ) +
  coord_fixed() +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 90, vjust = 0.5)
  )
```

```{r {{id}}-wijziging-jaar-alles2, fig.cap = "(ref:{{id}}-raster)", eval = output_format != "html" && nrow(deze_wijziging) > 0}
deze_wijziging %>%
  filter(!cycle) %>%
  ggplot(aes(x = naar, y = referentie, colour = log_mean)) +
  stat_effect(
    aes(ymin = lcl90, ymax = ucl90), 
    threshold = c(0.75, 1/0.75), 
    reference = 1
  ) +
  scale_x_continuous(breaks = pretty) +
  scale_y_continuous(breaks = pretty) +
  scale_effect("klasse", guide = guide_legend(ncol = 3)) +
  scale_colour_gradient2(
    "wijziging", breaks = index_breaks2, labels = index_labels
  ) +
  coord_fixed() +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 90, vjust = 0.5)
  )
```

(ref:{{id}}-stratumgewicht) Stratumgewicht, raming aan het aantal hokken waarin de soort aanwezig is, 
aantal relevant hokken voor de analyse, aantal onderzochte hokken in het 
stratum, totaal aantal hokken van het stratum in Vlaanderen en aantal bezoeken 
aan een meetpunt voor `r soort_naam` (zie §\@ref(s:stratumgewicht)).

```{r {{id}}-stratum-gewicht}
dit_stratum %>%
  select(-hash) %>%
  mutate(
    gewicht = sprintf("%.1f%%", 100 * gewicht),
    aanwezig = round(aanwezig, 1)
  ) %>%
  kable(
    caption = "(ref:{{id}}-stratumgewicht)",
    align = c("lrrrrrr")
  )
```

(ref:{{id}}-hash) Data-hashes van de analyses in het kader van traceerbaarheid (zie §\@ref(s:traceerbaarheid)).

```{r {{id}}-hash, results = "asis"}
resultaten$meta %>%
  filter(hash == id) %>%
  arrange(cycle, nonlinear) %>%
  transmute(
    frequentie = factor(
      cycle, 
      levels = c(TRUE, FALSE), 
      labels = c("driejaarlijks", "jaarlijks")
    ),
    model = ifelse(nonlinear, "lineair", "niet-lineair"),
    analyse = str_replace(analysis, "(.{20})", "\\1 "), 
    status = str_replace(status, "(.{20})", "\\1 ")
  ) %>%
  pandoc.table(caption = "(ref:{{id}}-hash)")
```
